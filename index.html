<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Phalanx</title>
    <link rel="stylesheet" href="index.css">
    <script src="./bower_components/js-md5/build/md5.min.js"></script>
  </head>
  <body>
    <div class="main">
      <h1>Phalanx</h1>
      <p id="result"></p>
      <table>
        <tr>
          <td>マスターパスワード</td>
          <td><input type="password" id="password"></td>
        </tr>
        <tr>
          <td>パスワードの桁数</td>
          <td><input type="number" id="digits" value="32"></td>
        </tr>
        <tr>
          <td>画像ファイル</td>
          <td><input type="file" id="file"></td>
        </tr>
      </table>
      <div class="center">
        <input type="button" id="generate" onclick="generate()" value="生成">
      </div>
    </div>
  <script>
    function mergeTypedArraysUnsafe(a, b) {
      var c = new a.constructor(a.length + b.length);
      c.set(a);
      c.set(b, a.length);
      return c;
    }

    let binary = null;
    let fileInput = document.getElementById('file');
    let passwordInput = document.getElementById("password");
    let digitsInput = document.getElementById("digits");
    let fileReader = new FileReader();

    function generate() {
      fileReader.readAsArrayBuffer(fileInput.files[0]);
    }
    fileReader.onload = () => {
      binary = new Uint8Array(fileReader.result)
      let pw = (new TextEncoder("utf-8").encode(passwordInput.value));
      let digits = parseInt(digitsInput.value);
      
      var hash = md5(mergeTypedArraysUnsafe(binary, pw));
      console.log(binary)
      document.getElementById("result").innerHTML = window.btoa(hash).slice(0, digits);

    }
  </script>

  </body>
</html>
